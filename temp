Option Explicit

Private Sub Worksheet_Change(ByVal Target As Range)
    Dim ws As Worksheet
    Set ws = Me
    
    ' 只在 B4:C7 變動時觸發
    If Intersect(Target, ws.Range("B4:C7")) Is Nothing Then Exit Sub
    
    On Error GoTo CleanFail
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    
    '=== 基本設定 ===
    Dim outputStartRow As Long
    outputStartRow = 11                  ' 輸出起始列
    Dim currentRow As Long
    currentRow = outputStartRow
    
    ' 先清空舊輸出（B11 以下）
    ws.Rows(outputStartRow & ":" & ws.Rows.Count).ClearContents
    ws.Rows(outputStartRow & ":" & ws.Rows.Count).ClearFormats
    
    '=== 逐列讀取通路與年期（B4:C7） ===
    Dim r As Long
    Dim 通路 As String
    Dim 年期 As String
    Dim 範本範圍 As Range
    
    For r = 4 To 7
        通路 = Trim$(CStr(ws.Cells(r, "B").Value))
        年期 = Trim$(CStr(ws.Cells(r, "C").Value))
        
        If Len(通路) > 0 And Len(年期) > 0 Then
            ' 標題列
            With ws.Cells(currentRow, "B")
                .Value = 通路 & "－" & 年期 & "年期"
                .Font.Bold = True
                .Interior.Color = RGB(242, 242, 242) ' 淺灰底
            End With
            currentRow = currentRow + 1
            
            ' 依通路挑範本
            Select Case Trim$(通路)
                Case "業務"
                    Set 範本範圍 = ws.Range("B61:Y65")
                Case "經代"
                    Set 範本範圍 = ws.Range("B66:Y70")
                Case "銀保"
                    Set 範本範圍 = ws.Range("B71:Y79")
                Case "理財"
                    Set 範本範圍 = ws.Range("B80:Y83")
                Case Else
                    ' 無此通路名稱，跳過
                    GoTo NextRow
            End Select
            
            ' 複製貼上框框
            範本範圍.Copy
            ws.Cells(currentRow, "B").PasteSpecial xlPasteAll
            
            ' 下一塊起始列（+範本高度 + 1 空白行）
            currentRow = currentRow + 範本範圍.Rows.Count + 1
        End If
NextRow:
    Next r
    
CleanOK:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Exit Sub
    
CleanFail:
    ' 發生錯誤也要把事件打開
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    MsgBox "產生時發生錯誤：" & Err.Number & " - " & Err.Description, vbExclamation
End Sub