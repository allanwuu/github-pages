# -*- coding: utf-8 -*-
"""
ä¿èª åˆ†ç´…ä¿å–®ï¼šä¸€æ¬¡æŠ“æ‰€æœ‰ã€Œæœ‰åˆ©ç‡è³‡æ–™ã€çš„å•†å“
æ‰€æœ‰å®£å‘Šå¹´åº¦ Ã— åˆ†ç´…å®£å‘Šæ¯”ç‡ï¼ˆå¹´åº¦ç´…åˆ© + çµ‚æœŸ/é•·å£½ç´…åˆ©ï¼‰

è¼¸å‡ºï¼š
 1) pcalife_bonus_all_years.xlsx       -> æ¯å•†å“ Ã— å¹´åº¦ Ã— åˆ†ç´…æ¯”ç‡
 2) pcalife_bonus_failed_seqno.xlsx   -> seqNo æŠ“ä¸åˆ°è³‡æ–™çš„æ¸…å–®
"""

import requests
import pandas as pd
from time import sleep

# ========== 0. Headersï¼ˆç…§ä½ ç€è¦½å™¨çš„ Request Headersï¼‰ ==========
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",
    "Accept": "*/*",
    "Accept-Language": "zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7",
    "Accept-Encoding": "gzip, deflate, br, zstd",
    "Origin": "https://www.pcalife.com.tw",
    "Referer": "https://www.pcalife.com.tw/zh/products/participating-insurance/declaration-of-dividend/",
    "X-Requested-With": "XMLHttpRequest",
    "sec-ch-ua": '"Google Chrome";v="135", "Not-A.Brand";v="8", "Chromium";v="135"',
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": '"Windows"',
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "same-origin",
    "Connection": "keep-alive",
    "priority": "u=1, i",
    # âš  é€™è£¡è²¼ä½  DevTools çš„ cookie æ•´ä¸²ï¼ˆåªæœ‰è‹±æ–‡æ•¸å­—æ¨™é»ã€ä¸è¦ä¸­æ–‡ï¼‰
    "Cookie": 'åœ¨é€™è£¡è²¼ä½ è‡ªå·±çš„ Cookie æ•´ä¸²',
}

session = requests.Session()
session.headers.update(HEADERS)

# ========== 1. å•†å“æ¸…å–®ï¼ˆå°å¹£ + éå°å¹£ï¼‰ï¼Œå…§å« seqNo & planId ==========
LIST_URLS = [
    "https://online.pcalife.com.tw/cwsol/api/parPlan/ntdPlans",
    "https://online.pcalife.com.tw/cwsol/api/parPlan/notNtdPlans",
]

all_plans = []
for url in LIST_URLS:
    print(f"æŠ“å–å•†å“æ¸…å–®ï¼š{url}")
    r = session.get(url, timeout=10)
    r.raise_for_status()
    all_plans.extend(r.json())

df_plans = pd.DataFrame(all_plans)

# å¼·åˆ¶æŠŠ seqNo / planId éƒ½ç•¶å­—ä¸²è™•ç†ï¼ˆé¿å…è¢«è½‰æˆæ•´æ•¸ï¼‰
df_plans["seqNo"] = df_plans["seqNo"].astype(str)
df_plans["planId"] = df_plans["planId"].astype(str)

df_plans = df_plans.drop_duplicates(subset=["seqNo"]).reset_index(drop=True)

print(f"\nğŸ“Œ å•†å“æ¸…å–®ç­†æ•¸ï¼ˆå«å°å¹£+å¤–å¹£ï¼‰ï¼š{len(df_plans)}")
print(df_plans.head())

# ========== 2. ç”¨ seqNo æ‰“ detail API ==========
def fetch_detail_by_seqno(seq_no: str):
    """
    ç”¨ seqNo æŠ“åˆ©ç‡ JSONï¼š
      GET /cwsol/api/parPlan/{seqNo}
    """
    url = f"https://online.pcalife.com.tw/cwsol/api/parPlan/{seq_no}"
    try:
        r = session.get(url, timeout=10)
        if r.status_code == 200:
            return r.json(), url
        else:
            return None, f"status={r.status_code}"
    except Exception as e:
        return None, f"exception: {e}"

# ========== 3. é€ seqNo å±•é–‹åˆ©ç‡ ==========
rows = []          # æˆåŠŸå±•é–‹çš„åˆ†ç´…è³‡æ–™
failed_seqno = []  # å®Œå…¨æŠ“ä¸åˆ°æˆ–æ²’æœ‰ä»»ä½•åˆ©ç‡çš„ seqNoï¼ˆçµ¦ä½ æª¢æŸ¥ç”¨ï¼‰

for _, p in df_plans.iterrows():
    seq_no = p["seqNo"]      # detail API ç”¨é€™å€‹
    plan_id = p["planId"]    # çµ¦ä½ è­˜åˆ¥å•†å“ç”¨
    plan_name = p["planName"]

    print(f"\nâ–¶ è™•ç† seqNoï¼š{seq_no} | planIdï¼š{plan_id} | {plan_name}")

    data, info = fetch_detail_by_seqno(seq_no)

    if data is None:
        print("  âŒ API å¤±æ•—ï¼š", info)
        failed_seqno.append({
            "seqNo": seq_no,
            "planId": plan_id,
            "planName": plan_name,
            "reason": info,
        })
        continue

    # æœ‰äº›æœƒå› {"planName":"å•†å“ä¸å­˜åœ¨",...}
    if data.get("planName") == "å•†å“ä¸å­˜åœ¨":
        print("  âŒ å•†å“ä¸å­˜åœ¨")
        failed_seqno.append({
            "seqNo": seq_no,
            "planId": plan_id,
            "planName": plan_name,
            "reason": "å•†å“ä¸å­˜åœ¨",
        })
        continue

    currency = data.get("currency")
    reg_tab = data.get("regularBonusTab") or {}
    final_tab = data.get("finalBonusTab") or {}
    reg_ratios = data.get("regularBonusRatios") or []
    final_ratios = data.get("finalBonusRatios") or []

    # å®Œå…¨æ²’æœ‰ä»»ä½•åˆ†ç´…å¹´åº¦ï¼Œå°±ç®—å•†å“å­˜åœ¨ï¼Œä¹Ÿè¨˜åˆ° failed è£¡ï¼ˆæ–¹ä¾¿ä½ æª¢æŸ¥ï¼‰
    if (not reg_ratios) and (not final_ratios):
        print("  âš  å•†å“å­˜åœ¨ä½†æ²’æœ‰åˆ†ç´…å¹´åº¦è³‡æ–™")
        failed_seqno.append({
            "seqNo": seq_no,
            "planId": plan_id,
            "planName": plan_name,
            "reason": "ç„¡ regular/final åˆ†ç´…è³‡æ–™",
        })
        continue

    print("  âœ… æœ‰åˆ†ç´…è³‡æ–™ï¼Œå±•é–‹å¹´åº¦â€¦")

    # å¹´åº¦ç´…åˆ© regularBonusRatios
    for item in reg_ratios:
        rows.append({
            "seqNo": seq_no,
            "planId": plan_id,
            "planName": plan_name,
            "currency": currency,
            "bonusType": "regular",            # å¹´åº¦ç´…åˆ©
            "bonusName": reg_tab.get("name"),
            "planType": reg_tab.get("planType"),  # ç¾å¼ / è‹±å¼
            "year": item.get("year"),
            "ratio": item.get("ratio"),        # 100% / ä¸é©ç”¨ / ä¸åˆ†é…
        })

    # çµ‚æœŸ / é•·å£½ç´…åˆ© finalBonusRatios
    for item in final_ratios:
        rows.append({
            "seqNo": seq_no,
            "planId": plan_id,
            "planName": plan_name,
            "currency": currency,
            "bonusType": "final",              # çµ‚æœŸ / é•·å£½ç´…åˆ©
            "bonusName": final_tab.get("name"),
            "planType": final_tab.get("planType"),
            "year": item.get("year"),
            "ratio": item.get("ratio"),
        })

    # ä¸è¦å¤ªå…‡çŒ›æ‰“çˆ†å°æ–¹ serverï¼Œç¨å¾®å–˜ä¸€ä¸‹
    sleep(0.15)

# ========== 4. åŒ¯å‡º Excel ==========
df_success = pd.DataFrame(rows)
df_failed = pd.DataFrame(failed_seqno)

if not df_success.empty:
    # æ’ä¸€ä¸‹æ¬„ä½é †åºæ¯”è¼ƒå¥½çœ‹
    col_order = [
        "seqNo", "planId", "planName", "currency",
        "bonusType", "bonusName", "planType",
        "year", "ratio",
    ]
    df_success = df_success[col_order]

    df_success.to_excel("pcalife_bonus_all_years.xlsx", index=False)
    print("\nâœ… å·²è¼¸å‡ºï¼špcalife_bonus_all_years.xlsx")
else:
    print("\nâš  æ²’æœ‰ä»»ä½•æˆåŠŸçš„åˆ©ç‡è³‡æ–™ï¼ˆå¤šåŠæ˜¯ Cookie éæœŸæˆ– seqNo å…¨éƒ¨ç„¡åˆ†ç´…ï¼‰ã€‚")

df_failed.to_excel("pcalife_bonus_failed_seqno.xlsx", index=False)
print(f"âš  ç„¡æ³•å–å¾—åˆ†ç´…è³‡æ–™çš„ seqNo æœ‰ {len(df_failed)} ç­† â†’ pcalife_bonus_failed_seqno.xlsx")
