# -*- coding: utf-8 -*-
"""
å…ˆæ¸¬è©¦å“ªäº›ä¿èª åˆ†ç´…å•†å“æŠ“å¾—åˆ°åˆ©ç‡ï¼Œ
æŠŠã€ŒæŠ“å¾—åˆ°çš„å•†å“ã€å…ˆç”¢å‡ºä¸€ä»½ xlsxã€‚
"""

import requests
import pandas as pd
from time import sleep

# ======================================
# 1. å•†å“æ¸…å–® API
# ======================================

LIST_URLS = [
    "https://online.pcalife.com.tw/cwsol/api/parPlan/ntdPlans",
    "https://online.pcalife.com.tw/cwsol/api/parPlan/ntdNtdPlans",
]

# ======================================
# 2. æŠ“å•†å“æ¸…å–® & å»é‡
# ======================================

all_plans = []

for url in LIST_URLS:
    print(f"æŠ“å–å•†å“æ¸…å–®ï¼š{url}")
    r = requests.get(url, timeout=10)
    r.raise_for_status()
    data = r.json()
    all_plans.extend(data)

df_plans = pd.DataFrame(all_plans)
df_plans = df_plans.drop_duplicates(subset="planId").reset_index(drop=True)

print(f"å•†å“æ¸…å–®ç¸½æ•¸é‡ï¼š{len(df_plans)}")


# ======================================
# 3. å®šç¾©ï¼šæ¸¬è©¦å–®ä¸€å•†å“æ˜¯å¦æŠ“å¾—åˆ°åˆ©ç‡
# ======================================

def test_plan(plan_id: str):
    """
    ä¾ç…§ planId æ¸¬è©¦æ˜¯å¦æŠ“å¾—åˆ°åˆ©ç‡
    1) å…ˆè©¦ /parPlan/{planId}
    2) å†è©¦ nAbPlans?planId=xxx
    æˆåŠŸå›å‚³ (True, currency, used_url)
    å¤±æ•—å›å‚³ (False, reason, None)
    """
    # â‘  å…ˆè©¦ /parPlan/{planId}
    url1 = f"https://online.pcalife.com.tw/cwsol/api/parPlan/{plan_id}"
    try:
        r1 = requests.get(url1, timeout=10)
        if r1.status_code == 200:
            data = r1.json()
            return True, data.get("currency"), url1
        reason1 = f"status={r1.status_code} on {url1}"
    except Exception as e:
        reason1 = f"exception on {url1}: {e}"

    # â‘¡ å†è©¦ nAbPlans?planId=xxxï¼ˆæœ‰äº›å¤–å¹£æœƒèµ°é€™è£¡ï¼‰
    url2 = "https://online.pcalife.com.tw/cwsol/api/parPlan/nAbPlans"
    try:
        r2 = requests.get(url2, params={"planId": plan_id}, timeout=10)
        if r2.status_code == 200:
            data = r2.json()
            return True, data.get("currency"), r2.url
        reason2 = f"status={r2.status_code} on {url2}?planId={plan_id}"
    except Exception as e2:
        reason2 = f"exception on {url2}?planId={plan_id}: {e2}"

    # å…©å€‹éƒ½å¤±æ•—
    return False, reason1 + " | " + reason2, None


# ======================================
# 4. é€å•†å“æ¸¬è©¦ï¼Œåˆ†æˆ OK / å¤±æ•—å…©çµ„
# ======================================

ok_list = []
failed_list = []

for _, p in df_plans.iterrows():
    plan_id = str(p.get("planId"))
    plan_name = p.get("planName", "")

    print(f"\næ¸¬è©¦å•†å“ï¼š{plan_id}  {plan_name}")
    success, info, used_url = test_plan(plan_id)

    if success:
        currency = info
        print("  âœ… OKï¼Œå¯æŠ“åˆ°åˆ©ç‡ï¼Œcurrency =", currency)
        ok_list.append({
            "planId": plan_id,
            "planName": plan_name,
            "currency": currency,
            "usedUrl": used_url,
        })
    else:
        reason = info
        print("  âš ï¸ å¤±æ•—ï¼š", reason)
        failed_list.append({
            "planId": plan_id,
            "planName": plan_name,
            "reason": reason,
        })

    sleep(0.15)

# ======================================
# 5. åŒ¯å‡º xlsx
# ======================================

if ok_list:
    df_ok = pd.DataFrame(ok_list)
    df_ok.to_excel("pcalife_plans_ok.xlsx", index=False)
    print(f"\nâœ… å¯æŠ“åˆ°åˆ©ç‡çš„å•†å“å…± {len(df_ok)} ç­†ï¼Œå·²è¼¸å‡ºï¼špcalife_plans_ok.xlsx")
else:
    print("\nâš ï¸ æ²’æœ‰ä»»ä½•å•†å“è¢«åˆ¤å®šç‚º OK")

if failed_list:
    df_failed = pd.DataFrame(failed_list)
    df_failed.to_excel("pcalife_plans_failed.xlsx", index=False)
    print(f"âš ï¸ æŠ“ä¸åˆ°åˆ©ç‡çš„å•†å“å…± {len(df_failed)} ç­†ï¼Œå·²è¼¸å‡ºï¼špcalife_plans_failed.xlsx")
else:
    print("ğŸ‰ æ²’æœ‰å¤±æ•—å•†å“")