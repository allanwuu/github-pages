# -*- coding: utf-8 -*-
"""
ä¿èª åˆ†ç´…ä¿å–®ï¼šä¸€æ¬¡æŠ“æ‰€æœ‰å¯æŠ“åˆ°å•†å“çš„
æ‰€æœ‰å®£å‘Šå¹´åº¦ Ã— åˆ†ç´…å®£å‘Šæ¯”ç‡ï¼ˆå¹´åº¦ç´…åˆ© + çµ‚æœŸ/é•·å£½ç´…åˆ©ï¼‰

ä¸»è¼¸å‡ºï¼š
 - pcalife_bonus_all_years.xlsxï¼ˆæˆåŠŸï¼‰
 - pcalife_bonus_failed_plans.xlsxï¼ˆå¤±æ•—ï¼‰
"""

import requests
import pandas as pd
from time import sleep

# =========================
# 0. æ­£ç¢º Headersï¼ˆä½ æä¾›çš„å®Œæ•´ Chrome Headersï¼‰
# =========================

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36",
    "Accept": "*/*",
    "Accept-Language": "zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7",
    "Accept-Encoding": "gzip, deflate, br, zstd",

    "Origin": "https://www.pcalife.com.tw",
    "Referer": "https://www.pcalife.com.tw/zh/products/participating-insurance/declaration-of-dividend/",

    "X-Requested-With": "XMLHttpRequest",

    "sec-ch-ua": '"Google Chrome";v="135", "Not-A.Brand";v="8", "Chromium";v="135"',
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": '"Windows"',

    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "same-origin",

    "Connection": "keep-alive",
    "priority": "u=1, i",

    # âš  é€™è£¡è²¼ä½ è‡ªå·±çš„ Cookieï¼ˆè¦ç”¨å–®å¼•è™ŸåŒ…ä½æ•´ä¸²ï¼‰
    "Cookie": 'ä½ çš„Cookieè²¼åœ¨é€™è£¡ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼',
}

session = requests.Session()
session.headers.update(HEADERS)

# =========================
# 1. å•†å“æ¸…å–®ï¼ˆå°å¹£ + å¤–å¹£ï¼‰
# =========================

LIST_URLS = [
    "https://online.pcalife.com.tw/cwsol/api/parPlan/ntdPlans",
    "https://online.pcalife.com.tw/cwsol/api/parPlan/notNtdPlans",
]

all_plans = []

for url in LIST_URLS:
    print(f"æŠ“å–å•†å“æ¸…å–®ï¼š{url}")
    r = session.get(url, timeout=10)
    r.raise_for_status()
    all_plans.extend(r.json())

df_plans = pd.DataFrame(all_plans)

# âš  é€™è¡Œæ˜¯é—œéµï¼šä¿ç•™è‹±æ–‡å­— + æ•¸å­—ï¼Œä¸æœƒè¢«è½‰æˆ int
df_plans["planId"] = df_plans["planId"].astype(str)

df_plans = df_plans.drop_duplicates(subset="planId").reset_index(drop=True)

print(f"\nğŸ“Œ å•†å“æ¸…å–®æ•¸é‡ï¼š{len(df_plans)}")
print(df_plans.head())

# =========================
# 2. æŠ“å–®ä¸€å•†å“ API
# =========================

def fetch_detail(plan_id: str):
    url = f"https://online.pcalife.com.tw/cwsol/api/parPlan/{plan_id}"
    try:
        r = session.get(url, timeout=10)
        if r.status_code == 200:
            return r.json(), url
        else:
            return None, f"status={r.status_code}"
    except Exception as e:
        return None, str(e)

# =========================
# 3. æŠ“å…¨éƒ¨å•†å“åˆ©ç‡
# =========================

rows = []
failed = []

for _, row in df_plans.iterrows():

    plan_id = row["planId"]
    plan_name = row["planName"]

    print(f"\nâ–¶ è™•ç†å•†å“ï¼š{plan_id}  {plan_name}")

    data, info = fetch_detail(plan_id)

    if data is None or data.get("planName") == "å•†å“ä¸å­˜åœ¨":
        print(f"  âŒ æŠ“ä¸åˆ°åˆ©ç‡ï¼š{info}")
        failed.append({"planId": plan_id, "planName": plan_name, "reason": info})
        continue

    print(f"  âœ… API OKï¼š{info}")

    currency = data.get("currency")

    reg_tab = data.get("regularBonusTab") or {}
    final_tab = data.get("finalBonusTab") or {}

    # å¹´åº¦ç´…åˆ©
    for item in data.get("regularBonusRatios") or []:
        rows.append({
            "planId": plan_id,
            "planName": plan_name,
            "currency": currency,
            "bonusType": "regular",
            "bonusName": reg_tab.get("name"),
            "planType": reg_tab.get("planType"),
            "year": item.get("year"),
            "ratio": item.get("ratio"),
        })

    # çµ‚æœŸ / é•·å£½ç´…åˆ©
    for item in data.get("finalBonusRatios") or []:
        rows.append({
            "planId": plan_id,
            "planName": plan_name,
            "currency": currency,
            "bonusType": "final",
            "bonusName": final_tab.get("name"),
            "planType": final_tab.get("planType"),
            "year": item.get("year"),
            "ratio": item.get("ratio"),
        })

    sleep(0.15)

# =========================
# 4. åŒ¯å‡º Excel
# =========================

df_success = pd.DataFrame(rows)
df_fail = pd.DataFrame(failed)

if not df_success.empty:
    df_success.to_excel("pcalife_bonus_all_years.xlsx", index=False)
    print("\nğŸ‰ å·²è¼¸å‡ºï¼špcalife_bonus_all_years.xlsx")
else:
    print("\nâš  å…¨éƒ¨éƒ½å¤±æ•—ï¼Œè«‹ç¢ºèª Cookie æ˜¯å¦éæœŸ")

df_fail.to_excel("pcalife_bonus_failed_plans.xlsx", index=False)
print(f"âš  ç„¡æ³•æŠ“å–çš„å•†å“ {len(df_fail)} ç­† â†’ pcalife_bonus_failed_plans.xlsx")